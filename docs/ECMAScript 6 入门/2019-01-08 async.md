<!-- markdownlint-disable -->
# 2019-01-08 async




## async
### åˆè¯†async

> å‚è€ƒ
[Async/await - javascript.info](https://javascript.info/async-await)
[Understanding JavaScriptâ€™s async await](https://ponyfoo.com/articles/understanding-javascript-async-await)


asyncå‡½æ•°å¯¹Generatorçš„æ”¹è¿›

1. å†…ç½®æ‰§è¡Œå™¨ - è‡ªåŠ¨è°ƒç”¨next
2. è¿”å›å€¼æ˜¯Promise

```js
function timeout(ms) {
  return new Promise((resolve) => {
    setTimeout(resolve, ms);
  });
}
// asyncå‡½æ•°è¿”å›çš„æ˜¯promiseå¯¹è±¡ï¼ŒğŸ‘‡æ­¤å‡½æ•°è¿”å›å€¼æ˜¯undefined
async function timeout(ms) {
  await new Promise((resolve) => {
    setTimeout(resolve, ms);
  });
}
```

returnçš„å€¼ä¼šä¼ é€’ä¸ªthenæˆ–è€…catchæ•è·
> awaitå‘½ä»¤åé¢æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ç»“æœã€‚å¦‚æœä¸æ˜¯ Promise å¯¹è±¡ï¼Œå°±ç›´æ¥è¿”å›å¯¹åº”çš„å€¼ã€‚
> awaitåé¢çš„Promiseå¦‚æœå˜æˆrejectçŠ¶æ€ï¼Œåˆ™rejectçš„å‚æ•°ä¼šè¢«catchæ–¹æ³•çš„å›è°ƒå‡½æ•°æ¥æ”¶åˆ°ã€‚(åƒåŠ äº†returnä¸€æ ·)


1.
```js
// asyncå…³é”®å­—çš„ä½œç”¨
// 1. funcitonå‰çš„asyncè¡¨ç¤ºè¿”å›å‡½æ•°å§‹ç»ˆè¿”å›ä¸€ä¸ªpromiseï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šè‡ªåŠ¨åŒ…è£¹åœ¨resolved promiseä¸­
// 2. å…è®¸ä½¿ç”¨await

// ä»¥ä¸‹ä¸¤ä¸ªæ•ˆæœç›¸åŒ 
async function f() {
  return 1
}

async function f() {
  return Promise.resolve(1);
}
```

```js 
// å¤šä¸ªawaitæ˜¯æœ‰ä¸€ä¸ªrejectåˆ™è¢«catchï¼Œä¸‹é¢çš„ä¼šæ‰§è¡Œå—ï¼Ÿ
async function main() {
  try {
    const val1 = await firstStep();
    const val2 = await secondStep(val1);
    const val3 = await thirdStep(val1, val2);

    console.log('Final: ', val3);
  }
  catch (err) {
    console.error(err);
  }
}
```



1. awaitåªèƒ½åœ¨asyncå‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨ï¼Œawaitä½¿jsç­‰å¾…ï¼Œç›´åˆ°promiseæœ‰äº†ç»“æœï¼Œæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼ˆå¼‚æ­¥çš„ï¼‰
   awaitåé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªpromise(æˆ–thenableçš„æ–¹æ³•)
```js
async function f() {
  console.log(1)
  let result = await new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(2)
    }, 1000)
  })
  console.log(result)
}

f()
```


```
Promise.resolve()æ˜¯åŒæ­¥çš„ï¼Ÿ
```

try.. catch...ä¸æ˜¯ä¸èƒ½æ•è·å¼‚æ­¥é”™è¯¯å—ï¼Ÿï¼Ÿ
```js
// try catchæ•è·é”™è¯¯ï¼Œå¯æ•è·å¤šä¸ªawait
// 2. ä¹Ÿå¯ä»¥f().catch()æ•è·
async function f() {
  try {
    let response = await fetch('/no-user-here');
    let user = await response.json();
  } catch(err) {
    // catches errors both in fetch and response.json
    alert(err);
  }
}

f();
```


```js
// wait for the array of results
let results = await Promise.all([
  fetch(url1),
  fetch(url2),
  ...
]);
```
